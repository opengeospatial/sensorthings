[[relations-extension]]
== Relations Extension

The relations extension adds the ability to relate Things to other Things, Features to other Features, Datastreams to other Datastreams and Observations to other Observations.
These relations can be semantically annotated in both directions.
Possible use cases include:

* Linking sub-systems to their parent systems, both implemented as Things.
* Linking Datastreams that contain aggregate data to the source-Datastreams containing the raw data.
* Linking Rivers (Features) to the Rivers or Lakes that they flow into.
* Linking Rooms to the Floors they are on, and those Floors to the Buildings they are in.
* Linking derivative Observations to the source Observations they are derived from.

Relations can link between two Entities in the same service, or link to an external resource.

The entity types, properties and relations added by this extension are depicted in <<img-sta-extension-relations>>.
[#img-sta-extension-relations,link=figures/Datamodel-SensorThingsApi-V2-Relations.drawio.png, reftext='{figure-caption} {counter:figure-num}', title='Relations Extension']
image::figures/Datamodel-SensorThingsApi-V2-Relations.drawio.png[Relations Extension, align="center"]  



=== Requirement Class: RelationRole

When creating a relation between two entities, a key aspect of this relation is what it means that these two entities are related.
This meaning for a relation is the role of the relation and is described in the RelationRole entity that is associated with each relation.
A relation has two directions.
If Entity-A is related to Entity-B with role-1, then Entity-B is related to Entity-A with the inverse of role-1.
The RelationRole Entity holds a name and definition for both directions of the relation.



[requirements_class]
.relationrole

====
[%metadata]
identifier:: {identifier}/req-class/datamodel/relations/relationrole
obligation:: requirement
subject:: Target Type: Data Model
inherit:: {identifier}/req-class/datamodel/sensing/datastream
inherit:: {identifier}/req-class/datamodel/sensing/feature
inherit:: {identifier}/req-class/datamodel/sensing/observation
inherit:: {identifier}/req-class/datamodel/sensing/thing
requirement:: {identifier}/req/datamodel/relations/relationrole/properties
requirement:: {identifier}/req/datamodel/relations/relationrole/relations
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/relationrole/properties

Each RelationRole entity SHALL have the mandatory properties and MAY have the optional properties listed in Table <<relationrole-properties>>.
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/relationrole/relations

Each RelationRole entity SHALL have the direct relation between a RelationRole entity and other entity types listed in Table <<relationrole-relations>>.
====



[#relationrole-properties,reftext='{table-caption} {counter:table-num}']
.Properties of a RelationRole entity
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Name*
| *Description*
| *Data Type*
| *Multiplicity*

| `id`
| A unique, read-only property that serves as an identifier for the entity.
Its value is computed by the server when creating the entity unless specified by the client.
| ANY
| 1

| `name`
| The name of the relation in the source -> target direction.
Generally, this should be a verb so that _Source name Target_ forms a sentence. 
| String
| 1

| `definition`
| The URI that defines this role. 
| String
| 0..1

| `inverseName`
| The name of the relation in the target -> source direction.
Generally, this should be a verb so that _Target name Source_ forms a sentence. 
| String
| 1

| `inverseDefinition`
| The URI that defines the inverse of this role. 
| String
| 0..1

| `description`
| The human readable description of the RelationRole entity.
| String
| 0..1

| `properties`
| A JSON Object containing user-annotated properties.
| JSON Object
| 0..1
|====


[#relationrole-relations,reftext='{table-caption} {counter:table-num}']
.Direct relation between a RelationRole entity and other entity types
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Role*
| *Description*
| *Target Entity Type*
| *Multiplicity*

| `DatastreamRelations`
| The list of Datastream-Datastream relations that this RelationRole describes.
| `DatastreamRelation`
| 0..*

| `FeatureRelations`
| The list of Feature-Feature relations that this RelationRole describes.
| `FeatureRelation`
| 0..*

| `ObservationRelations`
| The list of Observation-Observation relations that this RelationRole describes.
| `ObservationRelation`
| 0..*

| `ThingRelations`
| The list of Thing-Thing relations that this RelationRole describes.
| `ThingRelation`
| 0..*
|====



=== Requirement Class: DatastreamRelation

A DatastreamRelation Entity relates a source Datastream to a target Datastream, or to an external resource, using a RelationRole.

[requirements_class]
.datastreamrelation

====
[%metadata]
identifier:: {identifier}/req-class/datamodel/relations/datastreamrelation
obligation:: requirement
subject:: Target Type: Data Model
requirement:: {identifier}/req/datamodel/relations/datastreamrelation/properties
requirement:: {identifier}/req/datamodel/relations/datastreamrelation/relations
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/datastreamrelation/properties

Each DatastreamRelation entity SHALL have the mandatory properties and MAY have the optional properties listed in Table <<datastreamrelation-properties>>.
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/datastreamrelation/relations

Each DatastreamRelation entity SHALL have the direct relation between a DatastreamRelation entity and other entity types listed in Table <<datastreamrelation-relations>>.
====



[#datastreamrelation-properties,reftext='{table-caption} {counter:table-num}']
.Properties of a DatastreamRelation entity
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Name*
| *Description*
| *Data Type*
| *Multiplicity*

| `id`
| A unique, read-only property that serves as an identifier for the entity.
Its value is computed by the server when creating  the entity unless specified by the client.
| ANY
| 1

| `externalTarget`
| A URL or URI of an external target that acts as the target for this relation.
If an externalTarget is set, the `Source` relation must not be set.
| String
| 0..1
|====


[#datastreamrelation-relations,reftext='{table-caption} {counter:table-num}']
.Direct relation between a DatastreamRelation entity and other entity types
[width="100%",cols="<3a,<3a,<20a,<3a,<",options="header"]
|====
| *Source Entity Type*
| *Role*
| *Description*
| *Target Entity Type*
| *Multiplicity*

| `DatastreamRelation`
| `Source`
| The source Datastream for this relation.
This is the inverse of `TargetDatastreamRelations`.
| `Datastream`
| 1

| `DatastreamRelation`
| `Target`
| The target Datastream for this relation.
This must be set if, and only if, the externalTarget property is not set.
This is the inverse of `SourceDatastreamRelations`.
| `Datastream`
| 0..1

| `Datastream`
| `TargetDatastreamRelations`
| The list of DatastreamRelation entities where this Datastream is the Source.
In other words, following this link leads to the Targets.
This is the inverse of `Source`.
| `DatastreamRelation`
| 0..*

| `Datastream`
| `SourceDatastreamRelations`
| The list of DatastreamRelation entities where this Datastream is the Target.
In other words, following this link leads to the Sources.
This is the inverse of `Target`.
| `DatastreamRelation`
| 0..*
|====



=== Requirement Class: FeatureRelation

A FeatureRelation Entity relates a source Feature to a target Feature, or to an external resource, using a RelationRole.

[requirements_class]
.featurerelation

====
[%metadata]
identifier:: {identifier}/req-class/datamodel/relations/featurerelation
obligation:: requirement
subject:: Target Type: Data Model
requirement:: {identifier}/req/datamodel/relations/featurerelation/properties
requirement:: {identifier}/req/datamodel/relations/featurerelation/relations
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/featurerelation/properties

Each FeatureRelation entity SHALL have the mandatory properties and MAY have the optional properties listed in Table <<featurerelation-properties>>.
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/featurerelation/relations

Each FeatureRelation entity SHALL have the direct relation between a FeatureRelation entity and other entity types listed in Table <<featurerelation-relations>>.
====



[#featurerelation-properties,reftext='{table-caption} {counter:table-num}']
.Properties of a FeatureRelation entity
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Name*
| *Description*
| *Data Type*
| *Multiplicity*

| `id`
| A unique, read-only property that serves as an identifier for the entity.
Its value is computed by the server when creating  the entity unless specified by the client.
| ANY
| 1

| `externalTarget`
| A URL or URI of an external target that acts as the target for this relation.
If an externalTarget is set, the `Source` relation must not be set.
| String
| 0..1
|====


[#featurerelation-relations,reftext='{table-caption} {counter:table-num}']
.Direct relation between a FeatureRelation entity and other entity types
[width="100%",cols="<3a,<3a,<20a,<3a,<",options="header"]
|====
| *Source Entity Type*
| *Role*
| *Description*
| *Target Entity Type*
| *Multiplicity*

| `FeatureRelation`
| `Source`
| The source Feature for this relation.
This is the inverse of `TargetFeatureRelations`.
| `Feature`
| 1

| `FeatureRelation`
| `Target`
| The target Feature for this relation.
This must be set if, and only if, the externalTarget property is not set.
This is the inverse of `SourceFeatureRelations`.
| `Feature`
| 0..1

| `Feature`
| `TargetFeatureRelations`
| The list of FeatureRelation entities where this Feature is the Source.
In other words, following this link leads to the Targets.
This is the inverse of `Source`.
| `FeatureRelation`
| 0..*

| `Feature`
| `SourceFeatureRelations`
| The list of FeatureRelation entities where this Feature is the Target.
In other words, following this link leads to the Sources.
This is the inverse of `Target`.
| `FeatureRelation`
| 0..*
|====



=== Requirement Class: ObservationRelation

A ObservationRelation Entity relates a source Observation to a target Observation, or to an external resource, using a RelationRole.

[requirements_class]
.observationrelation

====
[%metadata]
identifier:: {identifier}/req-class/datamodel/relations/observationrelation
obligation:: requirement
subject:: Target Type: Data Model
requirement:: {identifier}/req/datamodel/relations/observationrelation/properties
requirement:: {identifier}/req/datamodel/relations/observationrelation/relations
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/observationrelation/properties

Each ObservationRelation entity SHALL have the mandatory properties and MAY have the optional properties listed in Table <<observationrelation-properties>>.
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/observationrelation/relations

Each ObservationRelation entity SHALL have the direct relation between a ObservationRelation entity and other entity types listed in Table <<observationrelation-relations>>.
====



[#observationrelation-properties,reftext='{table-caption} {counter:table-num}']
.Properties of a ObservationRelation entity
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Name*
| *Description*
| *Data Type*
| *Multiplicity*

| `id`
| A unique, read-only property that serves as an identifier for the entity.
Its value is computed by the server when creating  the entity unless specified by the client.
| ANY
| 1

| `externalTarget`
| A URL or URI of an external target that acts as the target for this relation.
If an externalTarget is set, the `Source` relation must not be set.
| String
| 0..1
|====


[#observationrelation-relations,reftext='{table-caption} {counter:table-num}']
.Direct relation between a ObservationRelation entity and other entity types
[width="100%",cols="<3a,<3a,<20a,<3a,<",options="header"]
|====
| *Source Entity Type*
| *Role*
| *Description*
| *Target Entity Type*
| *Multiplicity*

| `ObservationRelation`
| `Source`
| The source Observation for this relation.
This is the inverse of `TargetObservationRelations`.
| `Observation`
| 1

| `ObservationRelation`
| `Target`
| The target Observation for this relation.
This must be set if, and only if, the externalTarget property is not set.
This is the inverse of `SourceObservationRelations`.
| `Observation`
| 0..1

| `Observation`
| `TargetObservationRelations`
| The list of ObservationRelation entities where this Observation is the Source.
In other words, following this link leads to the Targets.
This is the inverse of `Source`.
| `ObservationRelation`
| 0..*

| `Observation`
| `SourceObservationRelations`
| The list of ObservationRelation entities where this Observation is the Target.
In other words, following this link leads to the Sources.
This is the inverse of `Target`.
| `ObservationRelation`
| 0..*
|====



=== Requirement Class: ThingRelation

A ThingRelation Entity relates a source Thing to a target Thing, or to an external resource, using a RelationRole.

[requirements_class]
.thingrelation

====
[%metadata]
identifier:: {identifier}/req-class/datamodel/relations/thingrelation
obligation:: requirement
subject:: Target Type: Data Model
requirement:: {identifier}/req/datamodel/relations/thingrelation/properties
requirement:: {identifier}/req/datamodel/relations/thingrelation/relations
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/thingrelation/properties

Each ThingRelation entity SHALL have the mandatory properties and MAY have the optional properties listed in Table <<thingrelation-properties>>.
====


[requirement]
====
[%metadata]
identifier:: {identifier}/req/datamodel/relations/thingrelation/relations

Each ThingRelation entity SHALL have the direct relation between a ThingRelation entity and other entity types listed in Table <<thingrelation-relations>>.
====



[#thingrelation-properties,reftext='{table-caption} {counter:table-num}']
.Properties of a ThingRelation entity
[width="100%",cols="<3a,<20a,<3a,<",options="header"]
|====
| *Name*
| *Description*
| *Data Type*
| *Multiplicity*

| `id`
| A unique, read-only property that serves as an identifier for the entity.
Its value is computed by the server when creating  the entity unless specified by the client.
| ANY
| 1

| `externalTarget`
| A URL or URI of an external target that acts as the target for this relation.
If an externalTarget is set, the `Source` relation must not be set.
| String
| 0..1
|====


[#thingrelation-relations,reftext='{table-caption} {counter:table-num}']
.Direct relation between a ThingRelation entity and other entity types
[width="100%",cols="<3a,<3a,<20a,<3a,<",options="header"]
|====
| *Source Entity Type*
| *Role*
| *Description*
| *Target Entity Type*
| *Multiplicity*

| `ThingRelation`
| `Source`
| The source Thing for this relation.
This is the inverse of `TargetThingRelations`.
| `Thing`
| 1

| `ThingRelation`
| `Target`
| The target Thing for this relation.
This must be set if, and only if, the externalTarget property is not set.
This is the inverse of `SourceThingRelations`.
| `Thing`
| 0..1

| `Thing`
| `TargetThingRelations`
| The list of ThingRelation entities where this Thing is the Source.
In other words, following this link leads to the Targets.
This is the inverse of `Source`.
| `ThingRelation`
| 0..*

| `Thing`
| `SourceThingRelations`
| The list of ThingRelation entities where this Thing is the Target.
In other words, following this link leads to the Sources.
This is the inverse of `Target`.
| `ThingRelation`
| 0..*
|====



